# 版本：1.3
# 修订原因：
# - 同步改进的文件大小验证方法，使用500字节作为阈值
# 版本：1.2
# 修订原因：
# - 修改提交注释，更便于查看来源
# 版本：1.1
# 修订原因：
# - 修复 git diff 检测逻辑，改为检查暂存区变更
# - 修复弃用的 ::set-output 语法，改用 $GITHUB_OUTPUT
# - 优化文件操作流程，移除冗余删除步骤
# - 备注：经常会无法正确更新，还需增加校验！！！
# 版本：1.0
# 功能：每天自动更新 Cloudflare 自建汇聚订阅 YAML 文件
# 核心流程：动态生成 URL → 下载文件 → 检测变更 → 提交推送 → 邮件通知

# 工作流名称
name: Update cmliu

# 触发条件
on:
  # 已改为手动模式，由统一工作流 update-all.yml 调度
  workflow_dispatch:

# 任务定义
jobs:
  # 任务名称：更新汇聚订阅文件
  update-cmliu-yaml:
    # 运行环境：最新版 Ubuntu
    runs-on: ubuntu-latest

    # 步骤序列
    steps:
      # --------------------------
      # 步骤 1：检出代码库
      # --------------------------
      - name: Checkout repository
        uses: actions/checkout@v3  # 使用 checkout v3 版本

      # --------------------------
      # 步骤 2：获取北京时间
      # --------------------------
      - name: Get current date (Beijing Time)
        id: date
        run: |
          # 设置环境变量（用于后续步骤和邮件通知）
          echo "YEAR=$(TZ='Asia/Shanghai' date +'%Y')" >> $GITHUB_ENV
          echo "MONTH=$(TZ='Asia/Shanghai' date +'%m')" >> $GITHUB_ENV
          echo "DAY=$(TZ='Asia/Shanghai' date +'%d')" >> $GITHUB_ENV
          echo "CURRENT_DATE=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV

      # --------------------------
      # 步骤 3：生成动态 URL
      # --------------------------
      - name: Generate dynamic URL
        run: |
          # 固定 URL（可根据需要改造为动态生成逻辑）
          echo "DYNAMIC_URL=https://cf-workers-sub-43i.pages.dev/sub?token=guest&clash" >> $GITHUB_ENV

      # --------------------------
      # 步骤 4：创建存储目录
      # --------------------------
      - name: Create cmliu directory if not exists
        run: |
          # -p 参数确保目录不存在时自动创建
          mkdir -p cmliu

      # --------------------------
      # 步骤 5：下载订阅文件（核心步骤）
      # --------------------------
      - name: Fetch content from dynamic URL
        id: fetch-content
        run: |
          # 使用curl下载文件，关键参数说明：
          # -L 跟随重定向（应对CDN切换）
          # -H 添加缓存控制头（避免获取缓存内容）
          if curl -L -H "Cache-Control: no-cache" -o cmliu/target.yaml "$DYNAMIC_URL"; then
            # 文件完整性检查
            if [ -s cmliu/target.yaml ]; then
              # 检查文件大小是否符合要求（大于500字节）
              FILE_SIZE=$(stat -c %s cmliu/target.yaml)
              if [ "$FILE_SIZE" -ge 500 ]; then
                echo "内容下载成功，文件大小为 $FILE_SIZE 字节"
                
                # 将文件添加到git暂存区（为后续变更检测准备）
                git add cmliu/target.yaml
                
                # 调试信息：显示文件哈希值
                echo "文件哈希: $(sha1sum cmliu/target.yaml)"
                # 显示git状态确认添加成功
                git status
              else
                echo "文件太小（$FILE_SIZE 字节），可能不是有效内容"
                echo "FETCH_ERROR=true" >> $GITHUB_OUTPUT
                exit 1
              fi
            else
              # 设置错误标记（空文件情况）
              echo "FETCH_ERROR=true" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            # 下载失败处理
            echo "FETCH_ERROR=true" >> $GITHUB_OUTPUT
            exit 1
          fi

      # --------------------------
      # 步骤 6：检测文件变更（改进点）
      # --------------------------
      - name: Check if file has changes
        id: check-changes
        run: |
          # 检查暂存区与仓库的差异（原工作区对比不准确）
          if git diff --staged --quiet; then
            echo "HAS_CHANGES=false" >> $GITHUB_OUTPUT
            echo "文件内容未发生变化"
          else
            echo "HAS_CHANGES=true" >> $GITHUB_OUTPUT
            echo "文件内容已发生变化"
          fi

      # --------------------------
      # 步骤 7：提交变更（条件执行）
      # --------------------------
      - name: Commit and push
        # 仅当检测到变化时执行
        if: steps.check-changes.outputs.HAS_CHANGES == 'true'
        run: |
          # 配置git用户信息（必需字段）
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # 提交信息包含北京时间戳
          git commit -m "cmliu_${{ env.CURRENT_DATE }} - Update from $DYNAMIC_URL"
          
          # 推送到远程仓库（使用GITHUB_TOKEN自动鉴权）
          git push

      # --------------------------
      # 步骤 8：异常通知（综合判断）
      # --------------------------
      - name: Notify on failure
        # 触发条件：任何失败/下载错误/无内容变化
        if: ${{ failure() || steps.fetch-content.outputs.FETCH_ERROR == 'true' || steps.check-changes.outputs.HAS_CHANGES == 'false' }}
        uses: dawidd6/action-send-mail@v3
        with:
          # SMTP服务器配置（163邮箱示例）
          server_address: smtp.163.com
          server_port: 465
          # 认证信息（需在仓库Secrets中设置）
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          
          # 邮件主题（含时间戳）
          subject: "cmliu汇聚订阅更新出错 ${{ env.CURRENT_DATE }}"
          
          # 邮件正文模板（使用管道符保持格式）
          body: |
            详情报告：
            - 时间: ${{ env.CURRENT_DATE }}
            - 脚本版本: 1.3
            - 订阅URL: ${{ env.DYNAMIC_URL }}
            - 日志链接: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            - 错误类型: ${{ steps.fetch-content.outputs.FETCH_ERROR && '下载失败' || steps.check-changes.outputs.HAS_CHANGES == 'false' && '内容未变' || '其他错误' }}
          
          # 收件人配置
          to: lyqnihao@163.com
          from: ${{ secrets.EMAIL_USERNAME }}
          # 内容类型设置为纯文本
          content_type: text/plain
