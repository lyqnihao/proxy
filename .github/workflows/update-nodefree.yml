name: Update nodefree

on:
  schedule:
    - cron: '05 5 * * *'  # 每天 UTC 时间 5:05 运行（北京时间 13:05）
  workflow_dispatch: # 允许手动触发

jobs:
  update-nodefree-yaml:
    runs-on: ubuntu-latest # 使用最新版本的 Ubuntu 作为运行环境

    steps:
      # 步骤 1：检出仓库代码
      - name: Checkout repository
        uses: actions/checkout@v3 # 使用 actions/checkout 动作检出仓库代码

      # 步骤 2：获取当前日期（北京时间）
      - name: Get current date (Beijing Time)
        id: date
        run: |
          # 设置环境变量 YEAR、MONTH、DAY 和 CURRENT_DATE，值为当前北京时间
          echo "YEAR=$(TZ='Asia/Shanghai' date +'%Y')" >> $GITHUB_ENV
          echo "MONTH=$(TZ='Asia/Shanghai' date +'%m')" >> $GITHUB_ENV
          echo "DAY=$(TZ='Asia/Shanghai' date +'%d')" >> $GITHUB_ENV
          echo "CURRENT_DATE=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV

      # 步骤 3：生成动态 URL
      - name: Generate dynamic URL
        run: |
          # 根据 YEAR、MONTH 和 DAY 生成动态 URL，并存储到 DYNAMIC_URL 环境变量中
          echo "DYNAMIC_URL=https://nodefree.githubrowcontent.com/$YEAR/$MONTH/$YEAR$MONTH$DAY.yaml" >> $GITHUB_ENV

      # 步骤 4：创建 nodefree 目录（如果不存在）
      - name: Create nodefree directory if not exists
        run: mkdir -p nodefree # 创建 nodefree 目录，-p 参数确保目录不存在时自动创建

      # 步骤 5：检查文件是否存在并删除
      - name: Check if file exists and delete
        run: |
          # 检查 nodefree/target.yaml 文件是否存在，如果存在则删除
          if [ -f nodefree/target.yaml ]; then
            rm nodefree/target.yaml
            echo "Deleted existing file: nodefree/target.yaml"
          else
            echo "File does not exist, skipping deletion"
          fi

      # 步骤 6：从动态 URL 获取内容
      - name: Fetch content from dynamic URL
        id: fetch-content
        run: |
          # 使用 curl 从动态 URL 下载内容并保存到 nodefree/target.yaml
          if curl -o nodefree/target.yaml "$DYNAMIC_URL"; then
            if [ -s nodefree/target.yaml ]; then
              echo "Content fetched successfully and file is not empty"
            else
              echo "File is empty, possible download error"
              echo "::set-output name=FETCH_ERROR::true"
              exit 1
            fi
          else
            echo "Failed to fetch content from $DYNAMIC_URL"
            echo "::set-output name=FETCH_ERROR::true"
            exit 1
          fi

      # 步骤 7：检查文件内容是否有变化
      - name: Check if file has changes
        id: check-changes
        run: |
          # 检查 nodefree/target.yaml 文件是否有变化
          if git diff --quiet nodefree/target.yaml; then
            echo "No changes detected in nodefree/target.yaml"
            echo "::set-output name=HAS_CHANGES::false"
          else
            echo "Changes detected in nodefree/target.yaml"
            echo "::set-output name=HAS_CHANGES::true"
          fi

      # 步骤 8：提交并推送更改（仅在内容有变化时执行）
      - name: Commit and push changes
        if: steps.check-changes.outputs.HAS_CHANGES == 'true'
        run: |
          # 配置 Git 用户名和邮箱
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          # 添加 nodefree/target.yaml 文件到暂存区
          git add nodefree/target.yaml
          # 提交更改，提交信息包含动态 URL
          git commit -m "Update nodefree yaml with content from $DYNAMIC_URL"
          # 推送更改到仓库
          git push https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

      # 步骤 9：发送邮件通知（内容无变化或工作流失败时）
      - name: Send email on no changes or failure
        if: ${{ failure() || steps.fetch-content.outputs.FETCH_ERROR == 'true' || steps.check-changes.outputs.HAS_CHANGES == 'false' }}
        uses: dawidd6/action-send-mail@v3 # 使用 dawidd6/action-send-mail 动作发送邮件
        with:
          server_address: smtp.163.com # 163 邮箱的 SMTP 服务器地址
          server_port: 465 # 163 邮箱的 SMTP 端口
          username: ${{ secrets.EMAIL_USERNAME }} # 你的 163 邮箱地址
          password: ${{ secrets.EMAIL_PASSWORD }} # 你的 163 邮箱授权码
          subject: "nodefree更新错误 ${{ env.CURRENT_DATE }}" # 邮件标题
          body: |
            工作流运行状态：
            - 动态 URL: ${{ env.DYNAMIC_URL }}
            - 日志链接: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            - 状态: ${{ steps.fetch-content.outputs.FETCH_ERROR == 'true' && '动态 URL 无法访问' || steps.check-changes.outputs.HAS_CHANGES == 'false' && '内容未发生变化' || '工作流运行失败' }}
          to: lyqnihao@163.com # 收件人邮箱
          from: ${{ secrets.EMAIL_USERNAME }} # 发件人邮箱
          content_type: text/plain # 邮件内容类型为纯文本
