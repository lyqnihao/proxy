# 版本 1.0
# 这是一个用于每天自动更新 README.md 文件的 GitHub Actions 工作流。
# 功能包括：根据日期动态更新部分订阅链接网址、内容检查、提交更改和邮件通知。


name: 更新 README 动态日期订阅网址

on:
  schedule:
    # 北京时间每天0点 = UTC 每天 16:00 (冬令时)
    - cron: '0 16 * * *'
  workflow_dispatch:

jobs:
  update-date:
    runs-on: ubuntu-latest

    steps:
      # 步骤1：检出代码
      - name: 检出仓库代码
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 步骤2：设置 Python 环境
      - name: 设置 Python 环境
        uses: actions/setup-python@v2
        with:
          python-version: '3.8'

      # 步骤3：获取北京时间
      - name: 获取北京时间
        id: date
        run: |
          CURRENT_DATE=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
          YEAR=$(TZ='Asia/Shanghai' date +'%Y')
          MONTH=$(TZ='Asia/Shanghai' date +'%m')
          DAY=$(TZ='Asia/Shanghai' date +'%d')
          echo "CURRENT_DATE=$CURRENT_DATE" >> $GITHUB_ENV
          echo "YEAR=$YEAR" >> $GITHUB_ENV
          echo "MONTH=$MONTH" >> $GITHUB_ENV
          echo "DAY=$DAY" >> $GITHUB_ENV
          echo "时间戳：$CURRENT_DATE"
          echo "日期：$YEAR$MONTH$DAY"

      # 步骤4：运行 Python 脚本更新日期
      - name: 更新 README.md 中的动态日期
        id: update-readme
        run: |
          python << 'EOF'
          import re
          import os

          # 读取 README.md 文件
          readme_path = 'README.md'
          with open(readme_path, 'r', encoding='utf-8') as f:
              content = f.read()

          # 获取当前日期
          year = os.environ.get('YEAR')
          month = os.environ.get('MONTH')
          day = os.environ.get('DAY')
          date_str = f"{year}{month}{day}"
          year_month = f"{year}/{month}"

          print(f"准备更新日期为：{date_str}")
          print(f"准备更新路径为：{year_month}")

          original_content = content
          
          # 支持的替换模式列表
          replacements = [
              # 模式1：$YEAR$MONTH$DAY 格式（直接8位数字）
              (r'\$YEAR\$MONTH\$DAY', date_str),
              
              # 模式2：$YEAR/$MONTH/$YEAR$MONTH$DAY 格式（带路径的格式）
              (r'\$YEAR/\$MONTH/\$YEAR\$MONTH\$DAY', f"{year_month}/{date_str}"),
              
              # 模式3：已有具体日期的替换（匹配 /YYYY/MM/YYYYMMDD 格式）
              (r'/\d{4}/\d{2}/\d{8}', f"/{year}/{month}/{date_str}"),
              
              # 模式4：v2clash.blog/Link/ 格式的日期
              (r'(v2clash\.blog/Link/)\d{8}(-v2ray\.txt|\.yaml)', rf'\g<1>{date_str}\2'),
              
              # 模式5：clashgithub.com 格式的日期
              (r'(clashgithub\.com/wp-content/uploads/rss/)\d{8}(\.txt|\.yml)', rf'\g<1>{date_str}\2'),
          ]
          
          # 执行所有替换
          for pattern, replacement in replacements:
              content = re.sub(pattern, replacement, content)
          
          # 检查是否有变化
          if content != original_content:
              print("✓ 检测到需要更新的内容")
              with open(readme_path, 'w', encoding='utf-8') as f:
                  f.write(content)
              print(f"✓ 已更新 README.md")
              print(f"✓ 日期值：{date_str}")
              print(f"✓ 路径值：{year_month}")
              print(f"✓ 已处理所有5种动态日期格式")
          else:
              print("✗ 未找到需要更新的动态日期标记")

          EOF

      # 步骤5：检测文件变更
      - name: 检测文件变更
        id: check-changes
        run: |
          git add README.md
          if git diff --staged --quiet; then
            echo "HAS_CHANGES=false" >> $GITHUB_OUTPUT
            echo "✗ README.md 文件未变化"
          else
            echo "HAS_CHANGES=true" >> $GITHUB_OUTPUT
            echo "✓ 检测到 README.md 变更"
          fi

      # 步骤6：提交变更
      - name: 提交变更
        if: steps.check-changes.outputs.HAS_CHANGES == 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git commit -m "chore: Update README dynamic date to ${{ env.YEAR }}${{ env.MONTH }}${{ env.DAY }} at ${{ env.CURRENT_DATE }}"
          git push

      # 步骤7：成功通知
      - name: 成功通知
        if: steps.check-changes.outputs.HAS_CHANGES == 'true'
        run: |
          echo "✓ README.md 已成功更新"
          echo "✓ 日期：${{ env.YEAR }}${{ env.MONTH }}${{ env.DAY }}"
          echo "✓ 时间：${{ env.CURRENT_DATE }}"

      # 步骤8：失败通知（邮件）
      - name: 失败通知
        if: failure() || steps.check-changes.outputs.HAS_CHANGES == 'false'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.163.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "README 日期更新失败 ${{ env.CURRENT_DATE }}"
          body: |
            README 日期更新出现问题：
            - 时间: ${{ env.CURRENT_DATE }}
            - 日期: ${{ env.YEAR }}${{ env.MONTH }}${{ env.DAY }}
            - 变更检测: ${{ steps.check-changes.outputs.HAS_CHANGES }}
            - 日志链接: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: lyqnihao@163.com
          from: ${{ secrets.EMAIL_USERNAME }}
          content_type: text/plain
