# 版本 1.0
# 这是一个用于每天自动更新 README.md 文件的 GitHub Actions 工作流。
# 功能包括：根据日期动态更新部分订阅链接网址、内容检查、提交更改和邮件通知。


name: 更新 README 动态日期订阅网址

on:
  # 已改为手动模式，由统一工作流 update-all.yml 调度
  workflow_dispatch:
  schedule:
  # 北京时间每天1:35运行(UTC时间17:35)
  - cron: '35 17 * * *'

jobs:
  update-date:
    runs-on: ubuntu-latest

    steps:
      # 步骤1：检出代码
      - name: 检出仓库代码
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 步骤2：设置 Python 环境
      - name: 设置 Python 环境
        uses: actions/setup-python@v2
        with:
          python-version: '3.8'

      # 步骤3：获取北京时间
      - name: 获取北京时间
        id: date
        run: |
          CURRENT_DATE=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
          YEAR=$(TZ='Asia/Shanghai' date +'%Y')
          MONTH=$(TZ='Asia/Shanghai' date +'%m')
          DAY=$(TZ='Asia/Shanghai' date +'%d')
          echo "CURRENT_DATE=$CURRENT_DATE" >> $GITHUB_ENV
          echo "YEAR=$YEAR" >> $GITHUB_ENV
          echo "MONTH=$MONTH" >> $GITHUB_ENV
          echo "DAY=$DAY" >> $GITHUB_ENV
          echo "时间戳：$CURRENT_DATE"
          echo "日期：$YEAR$MONTH$DAY"

      # 步骤3b：检查 v2clash.blog 是否有当天新帖（仅影响 proxyqueen/readme 中的 v2clash 链接）
      - name: 检查 v2clash.blog 是否有当天新帖
        id: check-v2clash
        run: |
          TODAY=$(TZ='Asia/Shanghai' date +'%Y%m%d')
          TODAY_ALT=$(TZ='Asia/Shanghai' date +'%Y-%m-%d')
          TODAY_CN=$(TZ='Asia/Shanghai' date +'%Y年%m月%d日')
          echo "检查 v2clash 博客主页是否包含日期： $TODAY 或 $TODAY_ALT 或 $TODAY_CN"
          if curl -sL https://v2clash.blog/ | grep -qE "$TODAY|$TODAY_ALT|$TODAY_CN"; then
            echo "HAS_V2CLASH_NEW=true" >> $GITHUB_ENV
            echo "检测到 v2clash 有今日文章，proxyqueen 订阅将更新"
          else
            echo "HAS_V2CLASH_NEW=false" >> $GITHUB_ENV
            echo "未检测到 v2clash 今日文章，proxyqueen 订阅将在本次跳过更新，但其它订阅仍会更新"
          fi

      # 步骤4：运行 Python 脚本更新日期
      - name: 更新 README.md 中的动态日期
        id: update-readme
        run: |
          python .github/scripts/update_readme.py

      # 步骤5：检测文件变更
      - name: 检测文件变更
        id: check-changes
        run: |
          git add README.md
          if git diff --staged --quiet; then
            echo "HAS_CHANGES=false" >> $GITHUB_OUTPUT
            echo "✗ README.md 文件未变化"
          else
            echo "HAS_CHANGES=true" >> $GITHUB_OUTPUT
            echo "✓ 检测到 README.md 变更"
          fi

      # 步骤6：提交变更
      - name: 提交变更
        if: steps.check-changes.outputs.HAS_CHANGES == 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git commit -m "自动更新日期至 ${{ env.YEAR }}${{ env.MONTH }}${{ env.DAY }} at ${{ env.CURRENT_DATE }}"
          git push

      # 步骤7：成功通知
      - name: 成功通知
        if: steps.check-changes.outputs.HAS_CHANGES == 'true'
        run: |
          echo "✓ README.md 已成功更新"
          echo "✓ 日期：${{ env.YEAR }}${{ env.MONTH }}${{ env.DAY }}"
          echo "✓ 时间：${{ env.CURRENT_DATE }}"

      # 步骤8：失败通知（邮件）
      - name: 失败通知（邮件）
        if: failure() || steps.check-changes.outputs.HAS_CHANGES == 'false'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.163.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "README 日期更新失败 ${{ env.CURRENT_DATE }}"
          body: |
            README 日期更新出现问题：
            - 时间: ${{ env.CURRENT_DATE }}
            - 日期: ${{ env.YEAR }}${{ env.MONTH }}${{ env.DAY }}
            - 变更检测: ${{ steps.check-changes.outputs.HAS_CHANGES }}
            - 日志链接: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: lyqnihao@163.com
          from: ${{ secrets.EMAIL_USERNAME }}
          content_type: text/plain